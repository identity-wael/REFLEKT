import { Tabs } from 'nextra/components'

# Component Interaction Diagram

This diagram shows the actual Earna AI system architecture with Supabase as the backend, featuring GPT-4o as the primary AI model with alternatives like Claude and Gemini, real-time messaging, and file attachments.

```mermaid
graph TB
    subgraph "Client Applications"
        WEB[Web App<br/>Next.js 15.4.6]
        CONSOLE[Console App<br/>Multi-Model Chat]
        DOCS[Documentation<br/>Nextra 4]
    end

    subgraph "Vercel Edge"
        EDGE[Edge Functions<br/>API Routes]
        AUTH_MW[Auth Middleware<br/>Supabase Auth]
        RATE[Rate Limiter<br/>Daily Limits]
        CACHE[Edge Cache<br/>CDN]
    end

    subgraph "Chat Processing"
        CHAT_API[Chat API<br/>Message Handler]
        STREAM[Response Streamer<br/>SSE]
        CONTEXT[Context Manager<br/>Chat History]
    end

    subgraph "AI Models"
        MODEL_ROUTER[Model Router<br/>Multi-Model]
        GPT4[GPT-4o<br/>Primary Model]
        CLAUDE[Claude 3 Opus<br/>Alternative]
        GEMINI[Gemini Pro<br/>Alternative]
        TOOLS[Tool Executor<br/>Functions]
    end

    subgraph "Supabase Backend"
        SUPABASE_AUTH[Supabase Auth<br/>User Management]
        SUPABASE_DB[Supabase DB<br/>PostgreSQL 15]
        SUPABASE_RLS[Row Level Security<br/>Data Protection]
        SUPABASE_RT[Realtime<br/>Subscriptions]
        SUPABASE_STORAGE[Storage Buckets<br/>File Attachments]
        SUPABASE_EDGE[Edge Functions<br/>Serverless]
    end

    subgraph "Database Tables"
        USERS[users table<br/>Profiles]
        CHATS[chats table<br/>Conversations]
        MESSAGES[messages table<br/>Chat History]
        PROJECTS[projects table<br/>Multi-Model]
        ATTACHMENTS[chat_attachments<br/>Files]
    end

    subgraph "Features"
        ANON[Anonymous Users<br/>No Login]
        PREMIUM[Premium Users<br/>Pro Features]
        DAILY_LIMITS[Daily Limits<br/>Message Counts]
    end

    %% Client to Edge connections
    WEB --> EDGE
    CONSOLE --> EDGE
    DOCS --> CACHE

    %% Edge middleware flow
    EDGE --> AUTH_MW
    AUTH_MW --> RATE
    RATE --> CHAT_API

    %% Chat processing flow
    CHAT_API --> CONTEXT
    CONTEXT --> MODEL_ROUTER
    MODEL_ROUTER --> STREAM
    STREAM --> WEB

    %% AI model routing
    MODEL_ROUTER --> GPT4
    MODEL_ROUTER --> CLAUDE
    MODEL_ROUTER --> GEMINI
    GPT4 --> TOOLS
    CLAUDE --> TOOLS
    GEMINI --> TOOLS

    %% Supabase Auth flow
    AUTH_MW --> SUPABASE_AUTH
    SUPABASE_AUTH --> USERS
    USERS --> ANON
    USERS --> PREMIUM

    %% Database operations
    CHAT_API --> SUPABASE_DB
    SUPABASE_DB --> SUPABASE_RLS
    SUPABASE_RLS --> CHATS
    SUPABASE_RLS --> MESSAGES
    SUPABASE_RLS --> PROJECTS
    SUPABASE_RLS --> ATTACHMENTS

    %% Realtime subscriptions
    MESSAGES --> SUPABASE_RT
    SUPABASE_RT --> WEB

    %% File storage
    ATTACHMENTS --> SUPABASE_STORAGE
    SUPABASE_STORAGE --> WEB

    %% Daily limits enforcement
    RATE --> DAILY_LIMITS
    DAILY_LIMITS --> USERS

    %% Edge functions
    TOOLS --> SUPABASE_EDGE
    SUPABASE_EDGE --> SUPABASE_DB

    %% Legend
    classDef client fill:#3B82F6,stroke:#2563EB,color:#fff
    classDef edge fill:#10B981,stroke:#059669,color:#fff
    classDef chat fill:#8B5CF6,stroke:#7C3AED,color:#fff
    classDef ai fill:#EC4899,stroke:#DB2777,color:#fff
    classDef supabase fill:#3ECF8E,stroke:#10B981,color:#fff
    classDef database fill:#06B6D4,stroke:#0891B2,color:#fff
    classDef feature fill:#F59E0B,stroke:#D97706,color:#fff

    class WEB,CONSOLE,DOCS client
    class EDGE,AUTH_MW,RATE,CACHE edge
    class CHAT_API,STREAM,CONTEXT chat
    class MODEL_ROUTER,CLAUDE,GPT4,GEMINI,TOOLS ai
    class SUPABASE_AUTH,SUPABASE_DB,SUPABASE_RLS,SUPABASE_RT,SUPABASE_STORAGE,SUPABASE_EDGE supabase
    class USERS,CHATS,MESSAGES,PROJECTS,ATTACHMENTS database
    class ANON,PREMIUM,DAILY_LIMITS feature
```

<Tabs items={['Communication Patterns', 'Service Details', 'Integration Points']}>
  <Tabs.Tab>
    **Communication Types:**

    | Pattern | Use Case | Technology | Latency |
    |---------|----------|------------|---------|
    | **REST API** | Web/mobile requests | Next.js API Routes | 50-200ms |
    | **WebSocket** | Real-time updates | Dashboard sync | < 100ms |
    | **Server Actions** | Form submissions | Next.js 15 | 100-500ms |
    | **Streaming** | AI responses | Server-Sent Events | 50-300ms |
    | **Edge Functions** | Authentication | Vercel Edge Runtime | 10-50ms |
    | **Database** | Persistent storage | PostgreSQL + Redis | 5-20ms |
    | **Vector Search** | Semantic queries | pgvector | 10-50ms |

    **Service Integration:**
    - Edge Functions for API endpoints
    - Environment variables for secure configuration
    - Webhook integration for credit bureau updates
    - Health checks via monitoring endpoints
    - Rate limiting for API protection
  </Tabs.Tab>

  <Tabs.Tab>
    **Service Responsibilities:**

    ```yaml
    Chat Processing:
      - Message validation and sanitization
      - Context loading and management
      - Response streaming via SSE
      - Conversation history tracking
      - Error recovery and fallbacks

    AI Orchestration:
      - Claude 3 Opus integration (alternative model)
      - Tool calling and execution
      - Prompt template management
      - Context window optimization
      - Performance monitoring

    Credit Analysis:
      - Canadian credit score interpretation
      - Equifax/TransUnion integration
      - Factor analysis (5 key factors)
      - Personalized recommendations
      - Improvement plan generation

    Banking Integration:
      - Plaid account connectivity
      - Transaction categorization
      - Spending pattern analysis
      - Bill payment tracking
      - Financial health scoring

    Data Services:
      - User data management (NeonDB)
      - Session caching (Redis)
      - Semantic search (pgvector)
      - Document storage (Blob)
      - PIPEDA compliance

    Edge Functions:
      - Firebase Authentication
      - Rate limiting per tier
      - Request routing
      - Response caching
      - Global distribution
    ```
  </Tabs.Tab>

  <Tabs.Tab>
    **Integration Points:**

    | Component | Inbound | Outbound | Protocol |
    |-----------|---------|----------|----------|
    | **Edge Functions** | Client requests | All services | HTTP/HTTPS |
    | **Chat Processor** | User messages | AI Model APIs | REST |
    | **AI Service** | Text prompts | Tool executor | Internal |
    | **Credit Analyzer** | User data | Bureau APIs | REST/SOAP |
    | **Plaid Connect** | Bank auth | Account data | REST |
    | **Context Manager** | Chat history | Redis cache | Redis Protocol |
    | **Database** | SQL queries | Persistent data | PostgreSQL |
    | **Vector Store** | Embeddings | Similarity search | SQL |
    | **External APIs** | Service requests | API responses | REST |
  </Tabs.Tab>
</Tabs>
