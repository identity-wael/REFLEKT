openapi: 3.0.0
info:
  title: Earna AI Console API
  description: API for managing users, organizations, and admin operations in Earna AI
  version: 1.0.0
  contact:
    name: Earna AI Support
    email: support@earna.ai
    url: https://earna.ai

servers:
  - url: http://localhost:3000/api
    description: Local Development
  - url: https://console.earna.ai/api
    description: Production

security:
  - bearerAuth: []

tags:
  - name: Users
    description: User management operations
  - name: Organizations
    description: Organization management
  - name: Dashboard
    description: Dashboard data and analytics
  - name: Admin
    description: Administrative operations
  - name: Plaid
    description: Plaid integration for bank account connections and transactions

paths:
  /users:
    get:
      tags: [Users]
      summary: List all users
      description: Retrieve a paginated list of all users in the system
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Page number
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Items per page
        - in: query
          name: search
          schema:
            type: string
          description: Search query
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Users]
      summary: Create a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/{userId}:
    get:
      tags: [Users]
      summary: Get user by ID
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Users]
      summary: Update user
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    delete:
      tags: [Users]
      summary: Delete user
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '204':
          description: User deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations:
    get:
      tags: [Organizations]
      summary: List organizations
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  organizations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Organization'

    post:
      tags: [Organizations]
      summary: Create organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '201':
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'

  /dashboard/stats:
    get:
      tags: [Dashboard]
      summary: Get dashboard statistics
      responses:
        '200':
          description: Dashboard statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardStats'

  /dashboard/analytics:
    get:
      tags: [Dashboard]
      summary: Get analytics data
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date
          description: Start date for analytics
        - in: query
          name: endDate
          schema:
            type: string
            format: date
          description: End date for analytics
      responses:
        '200':
          description: Analytics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsData'

  /plaid/create-link-token:
    post:
      tags: [Plaid]
      summary: Create Plaid Link token
      description: Generate a link token for Plaid Link initialization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLinkTokenRequest'
      responses:
        '200':
          description: Link token created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LinkTokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/exchange-token:
    post:
      tags: [Plaid]
      summary: Exchange public token for access token
      description: Exchange a Plaid public token for an access token and store account connection
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExchangeTokenRequest'
      responses:
        '200':
          description: Token exchange successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeTokenResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/accounts:
    get:
      tags: [Plaid]
      summary: Get connected bank accounts
      description: Retrieve all bank accounts connected via Plaid for the authenticated user
      responses:
        '200':
          description: Bank accounts retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /plaid/accounts/{accountId}/refresh:
    post:
      tags: [Plaid]
      summary: Refresh account data
      description: Manually trigger a refresh of account balances and recent transactions
      parameters:
        - in: path
          name: accountId
          required: true
          schema:
            type: string
          description: Account ID to refresh
      responses:
        '200':
          description: Account refresh initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /plaid/transactions:
    get:
      tags: [Plaid]
      summary: Get transactions
      description: Retrieve transactions from connected bank accounts
      parameters:
        - in: query
          name: accountId
          schema:
            type: string
          description: Filter by specific account ID
        - in: query
          name: startDate
          schema:
            type: string
            format: date
          description: Start date for transaction range
        - in: query
          name: endDate
          schema:
            type: string
            format: date
          description: End date for transaction range
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Page number
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
          description: Items per page
      responses:
        '200':
          description: Transactions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/webhook:
    post:
      tags: [Plaid]
      summary: Handle Plaid webhook
      description: Receive and process webhook notifications from Plaid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlaidWebhook'
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook processed
        '400':
          $ref: '#/components/responses/BadRequest'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          example: usr_123456789
        email:
          type: string
          format: email
          example: user@example.com
        name:
          type: string
          example: John Doe
        role:
          type: string
          enum: [admin, user, viewer]
        organizationId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateUserRequest:
      type: object
      required:
        - email
        - name
        - role
      properties:
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [admin, user, viewer]
        organizationId:
          type: string

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [admin, user, viewer]

    Organization:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        memberCount:
          type: integer
        createdAt:
          type: string
          format: date-time

    CreateOrganizationRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string

    DashboardStats:
      type: object
      properties:
        totalUsers:
          type: integer
        activeUsers:
          type: integer
        totalOrganizations:
          type: integer
        recentActivity:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              description:
                type: string
              timestamp:
                type: string
                format: date-time

    AnalyticsData:
      type: object
      properties:
        userGrowth:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              count:
                type: integer
        apiUsage:
          type: array
          items:
            type: object
            properties:
              endpoint:
                type: string
              count:
                type: integer

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        statusCode:
          type: integer

    CreateLinkTokenRequest:
      type: object
      required:
        - userId
      properties:
        userId:
          type: string
          description: User ID for the Link token
        products:
          type: array
          items:
            type: string
            enum: [transactions, auth, identity, assets]
          default: [transactions, auth]
        institutionId:
          type: string
          description: Optional institution ID for Update Mode

    LinkTokenResponse:
      type: object
      properties:
        linkToken:
          type: string
          description: Link token for Plaid Link initialization
        expiration:
          type: string
          format: date-time
          description: Token expiration timestamp

    ExchangeTokenRequest:
      type: object
      required:
        - publicToken
      properties:
        publicToken:
          type: string
          description: Public token from Plaid Link
        metadata:
          type: object
          description: Optional metadata from Link

    ExchangeTokenResponse:
      type: object
      properties:
        itemId:
          type: string
          description: Plaid item ID
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/Account'
        message:
          type: string
          example: Bank account connected successfully

    Account:
      type: object
      properties:
        id:
          type: string
          description: Account ID
        plaidAccountId:
          type: string
          description: Plaid's account ID
        name:
          type: string
          description: Account name
        officialName:
          type: string
          description: Official account name from institution
        type:
          type: string
          enum: [depository, credit, loan, investment, other]
        subtype:
          type: string
          description: Account subtype (checking, savings, etc.)
        mask:
          type: string
          description: Last 4 digits of account number
        balance:
          $ref: '#/components/schemas/Balance'
        institutionName:
          type: string
          description: Financial institution name
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Balance:
      type: object
      properties:
        available:
          type: number
          format: float
          description: Available balance
        current:
          type: number
          format: float
          description: Current balance
        limit:
          type: number
          format: float
          description: Credit limit (for credit accounts)
        isoCurrencyCode:
          type: string
          example: USD
        lastUpdated:
          type: string
          format: date-time

    Transaction:
      type: object
      properties:
        id:
          type: string
          description: Transaction ID
        plaidTransactionId:
          type: string
          description: Plaid's transaction ID
        accountId:
          type: string
          description: Associated account ID
        amount:
          type: number
          format: float
          description: Transaction amount (positive for outflows)
        date:
          type: string
          format: date
          description: Transaction date
        name:
          type: string
          description: Transaction description
        merchantName:
          type: string
          description: Merchant name if available
        category:
          type: array
          items:
            type: string
          description: Transaction category hierarchy
        categoryId:
          type: string
          description: Plaid category ID
        subcategory:
          type: string
          description: Transaction subcategory
        type:
          type: string
          enum: [adjustment, atm, bank_charge, bill_payment, cash, cashback, cheque, credit, debit, deposit, digital, dividend, fee, interest, other, payment, payroll, purchase, standing_order, transfer, tax]
        pending:
          type: boolean
          description: Whether transaction is pending
        isoCurrencyCode:
          type: string
          example: USD
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    AccountsResponse:
      type: object
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/Account'
        totalCount:
          type: integer
          description: Total number of connected accounts

    TransactionsResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'
        pagination:
          $ref: '#/components/schemas/Pagination'
        totalCount:
          type: integer
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/Account'
          description: Associated accounts for context

    RefreshResponse:
      type: object
      properties:
        message:
          type: string
          example: Account refresh initiated
        jobId:
          type: string
          description: Background job ID for tracking
        estimatedCompletion:
          type: string
          format: date-time
          description: Estimated completion time

    PlaidWebhook:
      type: object
      required:
        - webhook_type
        - webhook_code
        - item_id
      properties:
        webhook_type:
          type: string
          enum: [TRANSACTIONS, AUTH, IDENTITY, ASSETS, HOLDINGS, INVESTMENTS, LIABILITIES, PAYMENT_INITIATION, TRANSFER, INCOME_VERIFICATION]
          description: Type of webhook
        webhook_code:
          type: string
          description: Specific webhook event code
        item_id:
          type: string
          description: Plaid item ID
        error:
          type: object
          description: Error information if applicable
        new_transactions:
          type: integer
          description: Number of new transactions (for TRANSACTIONS webhooks)
        removed_transactions:
          type: array
          items:
            type: string
          description: List of removed transaction IDs
        environment:
          type: string
          enum: [sandbox, development, production]
          description: Plaid environment

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
